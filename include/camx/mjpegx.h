#pragma once
#include "../serverx.h"
#include "../serverx/Request.h"
#include "../serverx/MultipartResponse.h"
#include "../serverx/RequestHandler.h"
#include "./camx.h"

using espx::Serverx;
using espx::serverx::Request;
using espx::serverx::Response;
using espx::serverx::MultipartResponse;
using espx::serverx::RequestHandler;

static const uint8_t MJPEG_INDEX[4116] = {31, 139, 8, 0, 0, 0, 0, 0, 0, 19, 181, 86, 223, 111, 219, 54, 16, 126, 247, 95, 113, 37, 138, 66, 66, 45, 201, 201, 178, 45, 72, 45, 195, 89, 127, 96, 5, 186, 167, 108, 232, 107, 105, 242, 44, 209, 161, 72, 129, 60, 203, 54, 130, 252, 239, 3, 169, 216, 142, 29, 55, 9, 48, 204, 15, 54, 143, 60, 126, 247, 125, 71, 222, 209, 227, 55, 210, 10, 218, 180, 8, 53, 53, 122, 50, 24, 111, 127, 144, 203, 201, 0, 0, 96, 76, 138, 52, 78, 254, 90, 180, 88, 193, 119, 156, 193, 13, 186, 14, 221, 184, 232, 231, 123, 159, 6, 137, 131, 168, 185, 243, 72, 37, 251, 231, 239, 47, 217, 37, 43, 14, 214, 172, 33, 52, 84, 178, 149, 146, 84, 151, 18, 59, 37, 48, 139, 198, 16, 148, 81, 164, 184, 206, 188, 224, 26, 203, 179, 124, 196, 192, 240, 6, 75, 214, 41, 92, 181, 214, 209, 14, 203, 11, 167, 90, 2, 239, 68, 201, 106, 162, 214, 95, 21, 197, 210, 180, 183, 85, 46, 108, 83, 76, 137, 43, 189, 82, 70, 10, 239, 139, 153, 179, 43, 143, 110, 122, 193, 38, 227, 162, 223, 247, 12, 136, 144, 38, 95, 120, 137, 90, 117, 46, 55, 72, 133, 105, 155, 98, 174, 52, 102, 158, 119, 232, 166, 231, 249, 40, 255, 181, 144, 202, 83, 241, 69, 105, 188, 9, 147, 249, 194, 63, 198, 30, 23, 125, 210, 198, 51, 43, 55, 48, 189, 197, 205, 178, 205, 125, 238, 107, 53, 167, 146, 9, 222, 210, 210, 33, 3, 161, 185, 247, 37, 91, 101, 94, 56, 68, 3, 245, 118, 48, 215, 184, 134, 197, 210, 147, 154, 111, 50, 129, 134, 208, 129, 34, 108, 252, 214, 152, 85, 217, 76, 115, 113, 203, 96, 157, 73, 78, 188, 100, 215, 109, 155, 164, 108, 50, 24, 75, 213, 109, 129, 35, 76, 248, 202, 132, 213, 80, 241, 54, 187, 0, 194, 53, 101, 94, 115, 194, 236, 108, 52, 234, 205, 30, 148, 61, 228, 68, 170, 174, 31, 69, 75, 53, 213, 22, 174, 89, 103, 124, 73, 150, 245, 233, 42, 154, 112, 13, 2, 1, 135, 243, 146, 169, 134, 87, 184, 59, 156, 98, 7, 50, 158, 45, 137, 172, 129, 169, 208, 74, 220, 238, 197, 239, 34, 132, 207, 97, 128, 160, 78, 25, 169, 42, 155, 253, 182, 165, 184, 170, 21, 33, 56, 187, 52, 18, 101, 214, 72, 104, 215, 217, 37, 180, 155, 236, 28, 196, 210, 121, 235, 178, 214, 170, 152, 154, 218, 118, 232, 174, 246, 16, 191, 143, 70, 108, 175, 231, 99, 31, 30, 146, 155, 112, 22, 240, 30, 124, 250, 192, 184, 231, 121, 154, 52, 174, 21, 61, 236, 252, 102, 109, 123, 72, 126, 157, 249, 218, 174, 74, 70, 170, 65, 247, 146, 46, 103, 61, 254, 39, 85, 17, 224, 80, 211, 13, 217, 22, 98, 128, 135, 228, 190, 70, 81, 64, 125, 81, 210, 155, 87, 105, 250, 191, 206, 234, 250, 145, 36, 192, 14, 221, 6, 60, 10, 107, 228, 145, 190, 135, 219, 182, 45, 102, 137, 115, 116, 175, 40, 105, 174, 91, 101, 112, 225, 167, 191, 228, 103, 23, 249, 101, 95, 209, 193, 179, 81, 230, 184, 158, 31, 55, 13, 105, 197, 178, 65, 67, 57, 151, 242, 115, 135, 134, 190, 41, 79, 104, 208, 37, 172, 135, 188, 10, 77, 140, 13, 33, 73, 161, 156, 192, 221, 94, 79, 92, 205, 67, 189, 38, 161, 94, 119, 46, 201, 221, 65, 134, 99, 210, 175, 192, 44, 181, 30, 14, 14, 115, 223, 39, 35, 73, 225, 112, 71, 92, 179, 198, 91, 141, 185, 182, 85, 178, 171, 178, 244, 164, 27, 129, 224, 166, 227, 30, 202, 189, 24, 225, 144, 19, 126, 214, 24, 172, 0, 16, 28, 88, 58, 120, 10, 16, 87, 242, 216, 175, 161, 4, 170, 149, 207, 223, 58, 156, 251, 60, 182, 128, 220, 112, 90, 58, 174, 191, 135, 245, 159, 109, 174, 81, 85, 53, 61, 179, 251, 207, 232, 112, 34, 120, 207, 158, 214, 80, 110, 177, 42, 164, 143, 225, 69, 89, 83, 194, 206, 229, 41, 197, 180, 206, 165, 227, 171, 175, 33, 64, 114, 28, 113, 8, 163, 33, 140, 126, 174, 147, 236, 31, 218, 206, 146, 100, 166, 237, 44, 30, 86, 24, 192, 187, 119, 16, 30, 131, 107, 31, 231, 135, 240, 227, 237, 221, 251, 196, 224, 10, 62, 113, 194, 36, 77, 239, 243, 69, 91, 253, 72, 135, 208, 247, 197, 34, 182, 202, 67, 106, 247, 71, 103, 123, 92, 145, 39, 15, 57, 178, 63, 234, 70, 201, 83, 201, 209, 45, 94, 35, 40, 193, 35, 125, 13, 216, 29, 215, 73, 127, 223, 226, 242, 238, 46, 13, 225, 108, 116, 54, 122, 129, 220, 113, 200, 19, 220, 212, 28, 146, 125, 224, 167, 164, 98, 82, 53, 114, 183, 99, 243, 216, 251, 121, 13, 161, 22, 62, 28, 50, 220, 89, 247, 105, 31, 235, 62, 253, 48, 120, 252, 4, 135, 183, 55, 62, 197, 225, 111, 204, 191, 152, 207, 55, 195, 221, 8, 0, 0};

namespace espx::camx {
    /**
     * MJPEG HTTP server
     */
    class Mjpegx : public Serverx {
    public:

        /**
         * Start server
         * @return
         */
        Mjpegx& begin() {
            ::camx.runInBackground();
            Serverx::begin();
            ESP_LOGI("Mjpegx", "MJPEG server available at http://%s:%d", ip.c_str(), sconfig.port);

            return *this;
        }

    protected:
        friend class RequestHandler<Mjpegx>;
        Camx *cam;
        RequestHandler<Mjpegx> requestHandler;

        /**
         *
         * @return
         */
        String name() {
            return "Mjpeg";
        }

        /**
         * Get custom handler
         * @return
         */
        ThreadxTask handler() {
            return requestHandler;
        }

        /**
         * Handle the request
         */
        void handleRequest(Request *request) {
            if (request->path == "/") {
                Response response(request);

                response.ok();
                response.gzip("text/html", MJPEG_INDEX, sizeof(MJPEG_INDEX));
            }
            else {
                // serve stream on any other path
                size_t lastTimestamp = 0;
                MultipartResponse response = MultipartResponse(request);

                while (request->client->connected()) {
                    // get frame from queue
                    if (!::camx.lock()) {
                        delay(5);
                        continue;
                    }

                    if (::camx.frame.length > 0 && ::camx.frame.t != lastTimestamp) {
                        response.frame(::camx.frame.buf, ::camx.frame.length, "image/jpeg");
                        lastTimestamp = ::camx.frame.t;
                    }

                    ::camx.unlock();
                    delay(10);
                }
            }
        }
    };
}

static espx::camx::Mjpegx mjpegx;